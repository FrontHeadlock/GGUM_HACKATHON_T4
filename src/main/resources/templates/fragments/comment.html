<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<div th:fragment="commentItem" class="comment" th:data-comment-id="${comment.id}">
    <!-- 기존 댓글 내용 -->
    <div class="comment-main">
        <p th:text="${comment.content}">Comment content</p>
        <small th:text="${'By ' + comment.user.username}">By Username</small>
        <button th:onclick="'likeComment(' + ${comment.id} + ')'" class="comment-like-button">
            <span th:text="${comment.isLikedByCurrentUser(currentUser) ? 'Unlike' : 'Like'}">Like</span>
        </button>
        <span class="comment-like-count" th:text="${comment.likeCount} + ' likes'"></span>

        <!-- 답글 버튼 추가 -->
        <button class="reply-button" th:onclick="'showReplyForm(' + ${comment.id} + ')'">답글</button>
    </div>

    <!-- 답글 작성 폼 -->
    <div th:id="'reply-form-' + ${comment.id}" class="reply-form" style="display: none;">
        <input type="text" class="reply-input" th:placeholder="'답글을 입력하세요...'">
        <button class="reply-submit" th:onclick="'submitReply(' + ${comment.id} + ')'">답글 달기</button>
    </div>

    <!-- 답글 목록 -->
    <div class="replies" th:if="${not #lists.isEmpty(comment.replies)}">
        <div th:each="reply : ${comment.replies}" class="reply">
            <p th:text="${reply.content}">Reply content</p>
            <small th:text="${'By ' + reply.user.username}">By Username</small>
            <span class="reply-date" th:text="${#temporals.format(reply.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
    </div>
</div>

<!-- CSS 스타일 -->
<style>
    .comment {
        padding: 15px;
        border: 1px solid #ddd;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .comment-main {
        margin-bottom: 10px;
    }

    .reply-button {
        font-size: 0.9em;
        color: #666;
        background: none;
        border: none;
        cursor: pointer;
        margin-left: 10px;
    }

    .reply-form {
        margin: 10px 0 10px 20px;
    }

    .reply-input {
        width: 80%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 5px;
    }

    .reply-submit {
        padding: 8px 15px;
        border: none;
        border-radius: 4px;
        background-color: #405de6;
        color: white;
        cursor: pointer;
    }

    .replies {
        margin-left: 20px;
        border-left: 2px solid #ddd;
        padding-left: 15px;
    }

    .reply {
        margin: 10px 0;
        padding: 8px;
        background-color: #f9f9f9;
        border-radius: 4px;
    }

    .reply-date {
        font-size: 0.8em;
        color: #999;
        margin-left: 10px;
    }
</style>

<!-- JavaScript -->
<script th:inline="javascript">
    function showReplyForm(commentId) {
        const form = document.getElementById('reply-form-' + commentId);
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function submitReply(commentId) {
        const input = document.querySelector(`#reply-form-${commentId} .reply-input`);
        const content = input.value.trim();

        if (!content) {
            alert('답글 내용을 입력해주세요.');
            return;
        }

        fetch(`/api/replies/comments/${commentId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]')?.getAttribute('content')
            },
            body: JSON.stringify(content)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // 페이지 새로고침 대신 답글을 동적으로 추가
                const repliesDiv = document.querySelector(`[data-comment-id="${commentId}"] .replies`);
                if (!repliesDiv) {
                    // replies div가 없으면 새로 생성
                    const newRepliesDiv = document.createElement('div');
                    newRepliesDiv.className = 'replies';
                    document.querySelector(`[data-comment-id="${commentId}"]`).appendChild(newRepliesDiv);
                }

                const replyHtml = `
            <div class="reply">
                <p>${data.content}</p>
                <small>By ${data.user.username}</small>
                <span class="reply-date">${new Date(data.createdAt).toLocaleString()}</span>
            </div>
        `;
                repliesDiv.insertAdjacentHTML('beforeend', replyHtml);

                // 입력 필드 초기화 및 폼 숨기기
                input.value = '';
                document.getElementById('reply-form-' + commentId).style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                alert('답글 작성에 실패했습니다.');
            });
    }
</script>
</body>
</html>